var blockly_mario;(function(){function e(e,n,t){return Blockly.JavaScript.valueToCode(e,n,t)}Blockly.Language.agent_act={init:function(){this.setColour(290),this.appendDummyInput().appendTitle("activate"),this.appendValueInput("ACTION"),this.setInputsInline(!0),this.setPreviousStatement(!0),this.setNextStatement(!0),this.setTooltip("")}},Blockly.Language.agent_action={init:function(){this.setColour(160),this.appendDummyInput().appendTitle(new Blockly.FieldDropdown([["jump","jump"],["shoot","shoot"],["left","left"],["right","right"],["up","up"],["down","down"]]),"VALUE"),this.setInputsInline(!0),this.setOutput(!0,String),this.setTooltip("")}},Blockly.JavaScript.agent_act=function(){var n=e(this,"ACTION",Blockly.JavaScript.ORDER_NONE),t=["$$actions[",n,"] = true;\n"].join("");return t},Blockly.JavaScript.agent_action=function(){var e='"'+this.getTitleValue("VALUE")+'"';return[e,Blockly.JavaScript.ORDER_ATOMIC]}})(blockly_mario||(blockly_mario={}));var blockly_mario;(function(blockly_mario){function $(e){return document.getElementById(e)}function $input(e){return $(e)}function copySimpleShallow(e){var n={};for(var t in e)n[t]=e[t];return n}function defineFinishCode(e){return function(n){return e(["var $$actions;","return function() {","$$actions = {};",n,"return $$actions;","};"].join("\n"))}}function defineKeyDown(e){return function(n){if(this.IsActive()&&32==n.keyCode){var t=$input("pause");t.checked=!t.checked,handlePause()}else e.call(this,n)}}function handlePause(){$input("pause").checked?application.timer.Stop():application.timer.Start()}function redefine(e,n,t){e[n]=t(e[n])}function storageName(e){return window.location.href.split("#")[0]+"#"+e}function updateCode(){var code=Blockly.Generator.workspaceToCode("JavaScript");code=["(function() {",code,"})"].join("\n"),console.log(code);try{aiFunction=eval(code)(),$input("ai").disabled=!1,$input("update").disabled=!0}catch(e){throw alert("Error building code."),aiFunction=null,$input("ai").checked=!1,$input("ai").disabled=!0,e}}function workspaceChanged(){$("update").disabled=!1;var e=Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(Blockly.mainWorkspace));window.localStorage.setItem(storageName("blocks"),e)}var aiFunction,application;window.onload=function(){application=new Enjine.Application,application.Initialize(new Mario.LoadingState("../mariohtml5/"),320,240),application.timer.UpdateObject=new AiUpdate(application),redefine(Enjine.KeyboardInput,"KeyDownEvent",defineKeyDown),Blockly.inject($("blockly"),{path:"../blockly/",toolbox:$("toolbox")}),redefine(Blockly.JavaScript,"finish",defineFinishCode),Blockly.addChangeListener(workspaceChanged),$("ai").onclick=function(){$input("ai").checked||$("canvas").focus()},$input("pause").checked=!1,$("pause").onclick=handlePause,$("update").onclick=updateCode;var e=localStorage.getItem(storageName("blocks"));if(e){var n=Blockly.Xml.textToDom(e);Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,n)}setTimeout(function(){updateCode()},0)};var AiUpdate=function(){function e(e){this.base=e}return e.prototype.Update=function(e){var n,t=$input("ai").checked&&Boolean(aiFunction);if(t){var o=aiFunction(),i={},a={down:"Down",left:"Left",jump:"S",right:"Right",shoot:"A",up:"Up"};for(var c in o)o[c]&&(i[Enjine.Keys[a[c]]]=!0);n=Enjine.KeyboardInput.Pressed,Enjine.KeyboardInput.Pressed=i,Enjine.KeyboardInput.Element=null}this.base.Update(e),t&&(Enjine.KeyboardInput.Pressed=n,Enjine.KeyboardInput.Element=$("canvas"))},e}()})(blockly_mario||(blockly_mario={}));