var blockly_mario;(function(){function t(t,e,n){return Blockly.JavaScript.valueToCode(t,e,n)}Blockly.Language.agent_act={init:function(){this.setColour(290),this.appendDummyInput().appendTitle("activate"),this.appendValueInput("ACTION"),this.setInputsInline(!0),this.setPreviousStatement(!0),this.setNextStatement(!0),this.setTooltip("Activate or keep active the given action. Actions otherwise deactivate at each time step.\n\nTo actually jump or shoot more than once, it must be inactive between.")}},Blockly.Language.agent_action={init:function(){this.setColour(160),this.appendDummyInput().appendTitle(new Blockly.FieldDropdown([["jump","jump"],["shoot","shoot"],["left","left"],["right","right"],["up","up"],["down","down"]]),"VALUE"),this.setOutput(!0,String),this.setTooltip("Choose an action. Jump also starts levels. Shoot also runs faster.")}},Blockly.Language.agent_enemies={init:function(){this.setColour(210),this.appendDummyInput().appendTitle("enemies"),this.setOutput(!0,Array),this.setTooltip("A list of all enemies (in distance order?).")}},Blockly.Language.agent_mode={init:function(){this.setColour(120),this.appendDummyInput().appendTitle("game mode is").appendTitle(new Blockly.FieldDropdown([["level","LEVEL"],["map","MAP"],["title","TITLE"],["lose","LOSE"],["win","WIN"]]),"MODE"),this.setOutput(!0,Boolean),this.setTooltip("Test the current game mode (screen type).")}},Blockly.Language.agent_onGround={init:function(){this.setColour(120),this.appendDummyInput().appendTitle("on ground"),this.setOutput(!0,Boolean),this.setTooltip("On ground after last time step or not.")}},Blockly.Language.agent_velocity={helpUrl:"http://www.example.com/",init:function(){this.setColour(230),this.appendDummyInput().appendTitle("velocity"),this.setOutput(!0,Array),this.setTooltip("Most recent x and y velocity as list of two numbers.")}},Blockly.JavaScript.agent_act=function(){var e=t(this,"ACTION",Blockly.JavaScript.ORDER_NONE),n=["$$actions[",e,"] = true;\n"].join("");return n},Blockly.JavaScript.agent_action=function(){var t='"'+this.getTitleValue("VALUE")+'"';return[t,Blockly.JavaScript.ORDER_ATOMIC]},Blockly.JavaScript.agent_enemies=function(){return["$$support.enemies()",Blockly.JavaScript.ORDER_MEMBER]},Blockly.JavaScript.agent_mode=function(){var t={LEVEL:"Mario.LevelState",LOSE:"Mario.LoseState",MAP:"Mario.MapState",TITLE:"Mario.TitleState",WIN:"Mario.WinState"}[this.getTitleValue("MODE")],e="$$support.gameStateIs("+t+")";return[e,Blockly.JavaScript.ORDER_MEMBER]},Blockly.JavaScript.agent_onGround=function(){var t="Mario.MarioCharacter.OnGround";return[t,Blockly.JavaScript.ORDER_MEMBER]},Blockly.JavaScript.agent_velocity=function(){var t="[Mario.MarioCharacter.Xa, -Mario.MarioCharacter.Ya]";return[t,Blockly.JavaScript.ORDER_ATOMIC]},Blockly.JavaScript.text_print=function(){var e=t(this,"TEXT",Blockly.JavaScript.ORDER_NONE)||'""';return"console.log("+e+");\n"}})(blockly_mario||(blockly_mario={}));var blockly_mario;(function(t){var e=function(){function t(t){this.app=t}return t.prototype.enemies=function(){if(!this.gameStateIs(Mario.LevelState))return[];var t=this.gameState().Sprites.Objects.filter(function(t){return t instanceof Mario.Enemy||t instanceof Mario.BulletBill||Boolean(t instanceof Mario.Shell&&t.Facing)});return t},t.prototype.gameState=function(){return this.app.stateContext.State},t.prototype.gameStateIs=function(t){return this.gameState()instanceof t},t}();t.Support=e})(blockly_mario||(blockly_mario={}));var blockly_mario;(function(blockly_mario){function $(t){return document.getElementById(t)}function $input(t){return $(t)}function copySimpleShallow(t){var e={};for(var n in t)e[n]=t[n];return e}function defineFinishCode(t){return function(e){return t(["var $$actions;","return function() {","$$actions = {};",e,"return $$actions;","};"].join("\n"))}}function defineKeyDown(t){return function(e){if(this.IsActive()&&32==e.keyCode){var n=$input("pause");n.checked=!n.checked,handlePause()}else t.call(this,e)}}function handlePause(){$input("pause").checked?application.timer.Stop():application.timer.Start()}function redefine(t,e,n){t[e]=n(t[e])}function storageName(t){return window.location.href.split("#")[0]+"#"+t}function updateCode(){var code=Blockly.Generator.workspaceToCode("JavaScript");code=["(function($$support) {",code,"})"].join("\n");try{aiFunction=eval(code)(new blockly_mario.Support(application)),$input("ai").disabled=!1,$input("update").disabled=!0}catch(e){throw alert("Error building code."),aiFunction=null,$input("ai").checked=!1,$input("ai").disabled=!0,e}}function workspaceChanged(){$("update").disabled=!1;var t=Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(Blockly.mainWorkspace));window.localStorage.setItem(storageName("blocks"),t)}var aiFunction,application;window.onload=function(){application=new Enjine.Application,application.Initialize(new Mario.LoadingState("../mariohtml5/"),320,240),application.timer.UpdateObject=new AiUpdate(application),redefine(Enjine.KeyboardInput,"KeyDownEvent",defineKeyDown),Blockly.inject($("blockly"),{path:"../blockly/",toolbox:$("toolbox")}),redefine(Blockly.JavaScript,"finish",defineFinishCode),Blockly.addChangeListener(workspaceChanged),$("ai").onclick=function(){$input("ai").checked||$("canvas").focus()},$input("pause").checked=!1,$("pause").onclick=handlePause,$("update").onclick=updateCode;var t=localStorage.getItem(storageName("blocks"));if(t){var e=Blockly.Xml.textToDom(t);Blockly.Xml.domToWorkspace(Blockly.mainWorkspace,e)}setTimeout(function(){updateCode()},0)};var AiUpdate=function(){function t(t){this.base=t}return t.prototype.Update=function(t){var e,n=$input("ai").checked&&Boolean(aiFunction);if(n){var o=aiFunction(),i={},a={down:"Down",left:"Left",jump:"S",right:"Right",shoot:"A",up:"Up"};for(var r in o)o[r]&&(i[Enjine.Keys[a[r]]]=!0);e=Enjine.KeyboardInput.Pressed,Enjine.KeyboardInput.Pressed=i,Enjine.KeyboardInput.Element=null}this.base.Update(t),n&&(Enjine.KeyboardInput.Pressed=e,Enjine.KeyboardInput.Element=$("canvas"))},t}()})(blockly_mario||(blockly_mario={}));